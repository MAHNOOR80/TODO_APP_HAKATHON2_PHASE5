# Data Model: Advanced Level - Intelligent Features

**Feature**: 003-advanced-level
**Date**: 2025-12-27
**Status**: Phase 1 Design
**Purpose**: Define data structures for due dates, reminders, and recurring tasks

## Overview

This document specifies the data model extensions required for Advanced Level features. All changes extend the existing Task entity with optional fields to maintain backward compatibility.

## Core Entities

### Task Entity (Extended)

The Task entity is extended from Intermediate Level (002) with five new optional fields:

```python
from dataclasses import dataclass, field
from datetime import datetime

@dataclass
class Task:
    """
    Represents a single task with optional due dates, reminders, and recurrence.

    Backward Compatibility:
    - All Advanced Level fields default to None
    - Basic Level tasks: Only id, title, description, completed
    - Intermediate Level tasks: Add priority, tags
    - Advanced Level tasks: Add due dates, reminders, recurrence
    """

    # === Basic Level Fields (required) ===
    id: int
    title: str
    description: str = ""
    completed: bool = False

    # === Intermediate Level Fields (optional with defaults) ===
    priority: str = "medium"  # "low" | "medium" | "high"
    tags: list[str] = field(default_factory=list)

    # === Advanced Level Fields (NEW - all optional) ===
    due_date: datetime | None = None
    """
    When the task must be completed.
    Format: YYYY-MM-DD HH:MM (24-hour time, system local timezone)
    None = no due date set
    """

    reminder_offset: int | None = None
    """
    Minutes before due_date to trigger reminder.
    Valid values: 1440 (1 day), 60 (1 hour), 30 (30 min), 10 (10 min), or None
    Cannot be set if due_date is None
    None = no reminder
    """

    recurrence_pattern: str | None = None
    """
    How often the task repeats after completion.
    Valid values: "daily" | "weekly" | "monthly" | None
    Cannot be set if due_date is None
    None = non-recurring task
    """

    recurrence_end_date: datetime | None = None
    """
    Date after which no new recurring instances should be created.
    Format: YYYY-MM-DD HH:MM (must be >= due_date if set)
    None = recur indefinitely
    Ignored if recurrence_pattern is None
    """
```

### Field Validation Rules

| Field | Validation Rules | Error Handling |
|-------|------------------|----------------|
| `due_date` | Must be valid datetime (past dates allowed) | ValueError if parsing fails → show user-friendly error |
| `reminder_offset` | Must be in [1440, 60, 30, 10] if set | ValueError if invalid → show valid options |
| `reminder_offset` | Requires due_date to be set | ValueError → "Cannot set reminder without due date" |
| `recurrence_pattern` | Must be in ["daily", "weekly", "monthly"] if set | ValueError if invalid → show valid options |
| `recurrence_pattern` | Requires due_date to be set | ValueError → "Cannot set recurrence without due date" |
| `recurrence_end_date` | Must be >= due_date if both set | ValueError → "End date must be after due date" |

## Derived Data (Computed, Not Stored)

### Reminder Data

Reminders are **computed on-demand**, not stored as separate entities.

```python
@dataclass
class ReminderInfo:
    """
    Computed information about an active reminder.
    Generated by scanning tasks with due_date and reminder_offset.
    """
    task_id: int
    title: str
    due_datetime: datetime
    time_remaining: str  # Human-readable: "2 hours 30 minutes", "45 minutes"

    @property
    def is_active(self) -> bool:
        """
        Reminder is active if:
        - Current time >= (due_datetime - reminder_offset)
        - AND current time < due_datetime (not yet overdue)
        """
        trigger_time = self.due_datetime - timedelta(minutes=self.reminder_offset)
        now = datetime.now()
        return now >= trigger_time and now < self.due_datetime
```

### Overdue Status

Overdue status is a **computed property**, not a stored field.

```python
def is_overdue(task: Task) -> bool:
    """
    Returns True if task has passed its due_date.

    Logic:
    - If due_date is None: False (no deadline)
    - If due_date is set: datetime.now() > task.due_date
    """
    if task.due_date is None:
        return False
    return datetime.now() > task.due_date
```

## State Transitions

### Recurring Task Instance Generation

When a recurring task is marked complete:

```
[Recurring Task Completed]
         ↓
    Check: recurrence_pattern is not None?
         ↓ (Yes)
    Calculate next_occurrence = calculate_next_occurrence(current_due_date, pattern)
         ↓
    Check: recurrence_end_date is None OR next_occurrence <= recurrence_end_date?
         ↓ (Yes)
    Create new Task instance:
      - Copy: title, description, priority, tags, recurrence_pattern, recurrence_end_date, reminder_offset
      - Set: due_date = next_occurrence
      - Set: completed = False
      - Set: id = next_available_id
         ↓
    Add new task to task list
         ↓
    [Original task remains completed, new instance created]
```

**Important**: Each recurring instance is an **independent task**. Completing one instance does not affect others (except triggering creation of the next instance).

### Reminder Lifecycle

Reminders have no persistent state:

```
[App Startup]
     ↓
Scan all tasks where:
  - due_date is not None
  - reminder_offset is not None
  - is_overdue(task) == False
     ↓
For each task, calculate:
  - trigger_time = due_date - timedelta(minutes=reminder_offset)
  - is_active = datetime.now() >= trigger_time
     ↓
If is_active: Include in reminders list
     ↓
Display reminders before main menu
```

## Data Relationships

### Task → Due Date (1:1 optional)
- One task has zero or one due date
- Due date is embedded in Task entity (not separate table)

### Task → Reminder (1:1 optional, computed)
- One task has zero or one reminder configuration (offset)
- Reminder "active" status computed dynamically on each check

### Task → Recurrence Pattern (1:1 optional)
- One task has zero or one recurrence pattern
- Pattern stored as string literal ("daily", "weekly", "monthly")

### Task → Recurring Instances (1:many, implicit)
- One recurring task generates multiple independent task instances
- No explicit parent-child relationship stored
- Each instance is a full Task entity with same recurrence_pattern

## Storage Strategy

### In-Memory Storage (Phase I Constraint)

```python
# In todo_app.py
class TodoApp:
    def __init__(self):
        self.tasks: list[Task] = []
        self.next_id: int = 1
```

**Characteristics**:
- All tasks stored in Python list
- No persistence between sessions
- No serialization required (JSON export deferred to future phase)
- datetime objects remain as Python datetime (no string conversion)

**Implications**:
- User must recreate tasks each session
- Reminders recalculated on every startup
- Recurring tasks generate new instances only when original completed

## Constants

### Preset Reminder Offsets

```python
# In todo_app.py or task.py
REMINDER_1_DAY = 1440    # minutes (24 * 60)
REMINDER_1_HOUR = 60     # minutes
REMINDER_30_MIN = 30     # minutes
REMINDER_10_MIN = 10     # minutes

VALID_REMINDER_OFFSETS = [REMINDER_1_DAY, REMINDER_1_HOUR, REMINDER_30_MIN, REMINDER_10_MIN]
```

### Valid Recurrence Patterns

```python
# In todo_app.py or task.py
RECURRENCE_DAILY = "daily"
RECURRENCE_WEEKLY = "weekly"
RECURRENCE_MONTHLY = "monthly"

VALID_RECURRENCE_PATTERNS = [RECURRENCE_DAILY, RECURRENCE_WEEKLY, RECURRENCE_MONTHLY]
```

## Migration Strategy

### From Intermediate Level to Advanced Level

**No migration required** - backward compatible by design:

1. Existing tasks without due dates:
   - due_date = None (default)
   - reminder_offset = None (default)
   - recurrence_pattern = None (default)
   - Display unchanged

2. User adds due date to existing task:
   - Set due_date via new CLI command
   - reminder_offset and recurrence_pattern remain None
   - No data loss, no schema change

3. Code changes are **additive only**:
   - Task dataclass extended with new fields
   - New methods added to TodoApp
   - Existing methods unchanged (except completion logic for recurrence)

## Example Task States

### Basic Task (no due date)
```python
Task(
    id=1,
    title="Read documentation",
    description="Review the API docs",
    completed=False,
    priority="medium",
    tags=["learning"],
    due_date=None,          # No due date
    reminder_offset=None,   # No reminder
    recurrence_pattern=None # No recurrence
)
```

### Task with Due Date Only
```python
Task(
    id=2,
    title="Submit report",
    description="Q4 financial report",
    completed=False,
    priority="high",
    tags=["work", "urgent"],
    due_date=datetime(2025, 12, 31, 17, 0),  # Due Dec 31, 2025 at 5:00 PM
    reminder_offset=None,   # No reminder
    recurrence_pattern=None # No recurrence
)
```

### Task with Due Date and Reminder
```python
Task(
    id=3,
    title="Team meeting",
    description="Weekly standup",
    completed=False,
    priority="medium",
    tags=["meeting"],
    due_date=datetime(2025, 12, 28, 10, 0),  # Due Dec 28, 2025 at 10:00 AM
    reminder_offset=60,     # Remind 1 hour before (60 minutes)
    recurrence_pattern=None # No recurrence
)
```

### Recurring Task with Reminder
```python
Task(
    id=4,
    title="Daily standup",
    description="Team sync meeting",
    completed=False,
    priority="high",
    tags=["meeting", "daily"],
    due_date=datetime(2025, 12, 27, 9, 0),   # Due Dec 27, 2025 at 9:00 AM
    reminder_offset=10,     # Remind 10 minutes before
    recurrence_pattern="daily",  # Repeats daily
    recurrence_end_date=None     # No end date (recurs forever)
)
```

### Recurring Task with End Date
```python
Task(
    id=5,
    title="Weekly report",
    description="Status update for project alpha",
    completed=False,
    priority="medium",
    tags=["work", "project-alpha"],
    due_date=datetime(2025, 12, 30, 17, 0),  # Due Dec 30, 2025 at 5:00 PM
    reminder_offset=1440,   # Remind 1 day before
    recurrence_pattern="weekly",     # Repeats weekly
    recurrence_end_date=datetime(2026, 3, 31, 23, 59)  # Ends March 31, 2026
)
```

## Summary

**Data Model Complexity**: Low
- 5 new optional fields on existing Task entity
- 2 computed data types (ReminderInfo, overdue status)
- No new entities, no separate tables
- All relationships are 1:1 optional or implicit

**Backward Compatibility**: 100%
- All new fields have defaults (None)
- No changes to Basic/Intermediate Level task creation
- Progressive enhancement (features activate only when fields set)

**Storage**: In-memory list (constitution-compliant)
- No persistence, no serialization
- datetime objects stored natively (not converted to strings)

**Next Steps**:
- Phase 1: Create contracts/ directory with CLI command specifications
- Phase 1: Create quickstart.md with user workflows
- Phase 1: Update agent context with technology stack
