# Data Model: Cloud-Native Kubernetes Deployment

**Feature**: 007-cloud-native-k8s-deployment
**Date**: 2026-01-24
**Purpose**: Document new and modified data entities for Phase 4

## Overview

Phase 4 introduces one new database entity (`agent_suggestions`) and one field addition to the existing `users` table. All other existing entities remain unchanged to maintain backward compatibility.

## New Entity: Agent Suggestions

### Purpose

Store suggestions generated by autonomous background agents. These are read-only recommendations that users can view and dismiss. The agent never modifies task data directly.

### Schema

```sql
CREATE TABLE agent_suggestions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
  suggestion_type VARCHAR(50) NOT NULL,
  message TEXT NOT NULL,
  metadata JSONB DEFAULT '{}',
  dismissed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP
);

CREATE INDEX idx_agent_suggestions_user_id ON agent_suggestions(user_id);
CREATE INDEX idx_agent_suggestions_dismissed ON agent_suggestions(dismissed);
CREATE INDEX idx_agent_suggestions_type ON agent_suggestions(suggestion_type);
CREATE INDEX idx_agent_suggestions_created_at ON agent_suggestions(created_at);
```

### Prisma Schema

```prisma
model AgentSuggestion {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  taskId         String?  @map("task_id")
  suggestionType String   @map("suggestion_type")
  message        String
  metadata       Json     @default("{}")
  dismissed      Boolean  @default(false)
  createdAt      DateTime @default(now()) @map("created_at")
  expiresAt      DateTime? @map("expires_at")

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task? @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dismissed])
  @@index([suggestionType])
  @@index([createdAt])
  @@map("agent_suggestions")
}
```

### Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | UUID | Yes | Primary key, auto-generated |
| `user_id` | UUID | Yes | Foreign key to users table |
| `task_id` | UUID | No | Foreign key to tasks table (null for general suggestions) |
| `suggestion_type` | VARCHAR(50) | Yes | Type of suggestion (see Suggestion Types below) |
| `message` | TEXT | Yes | Human-readable suggestion message |
| `metadata` | JSONB | No | Additional structured data for the suggestion |
| `dismissed` | BOOLEAN | Yes | Whether user has dismissed this suggestion |
| `created_at` | TIMESTAMP | Yes | When the suggestion was created |
| `expires_at` | TIMESTAMP | No | Optional expiration (auto-dismiss after this time) |

### Suggestion Types

| Type | Description | Task Required | Example Message |
|------|-------------|---------------|-----------------|
| `overdue_reminder` | Task is past due date | Yes | "Task 'Buy groceries' was due 2 days ago" |
| `prioritization` | Suggest changing priority | Yes | "Consider raising priority of 'Submit report' - due tomorrow" |
| `schedule_adjustment` | Suggest rescheduling | Yes | "You have 5 tasks due today. Consider rescheduling some." |
| `neglected_task` | Task hasn't been updated | Yes | "Task 'Learn TypeScript' hasn't been updated in 30 days" |
| `general_insight` | General productivity insight | No | "You complete 30% more tasks in the morning" |

### Relationships

```
User (1) ──────< AgentSuggestion (*)
                      │
                      └──> Task (0..1)
```

- **User**: One user has many suggestions (cascade delete)
- **Task**: Optional reference to related task (cascade delete when task deleted)

### Validation Rules

1. `suggestion_type` MUST be one of the defined types
2. `message` MUST NOT be empty
3. `task_id` MUST be provided for task-specific suggestion types
4. `user_id` MUST match an existing user
5. Suggestions older than 30 days MAY be auto-deleted (retention policy)

### State Transitions

```
[Created] ──(user views)──> [Viewed] ──(user dismisses)──> [Dismissed]
    │                           │
    └────(expires_at reached)───┴──────────────────────────> [Expired/Deleted]
```

## Modified Entity: Users

### Addition: Autonomous Agents Preference

Add a boolean field to control whether autonomous agents generate suggestions for this user.

### Schema Change

```sql
ALTER TABLE users ADD COLUMN autonomous_agents_enabled BOOLEAN DEFAULT TRUE;
```

### Prisma Schema Update

```prisma
model User {
  // ... existing fields ...
  autonomousAgentsEnabled Boolean @default(true) @map("autonomous_agents_enabled")

  // ... existing relations ...
  agentSuggestions AgentSuggestion[]
}
```

### Business Rules

1. When `autonomous_agents_enabled = false`:
   - Background agents MUST NOT create suggestions for this user
   - Existing suggestions remain visible until dismissed
   - User can still view and dismiss existing suggestions

2. When `autonomous_agents_enabled = true` (default):
   - Background agents generate suggestions per normal schedule
   - Rate limit of 10 suggestions per user per hour applies

## Existing Entities (Unchanged)

The following entities from previous phases remain unchanged:

- **Users**: (except for new field above)
- **Tasks**: No changes
- **Sessions**: No changes (managed by Better Auth)
- **Accounts**: No changes (managed by Better Auth)

## Entity Relationship Diagram

```
┌─────────────────────────────────────────────────────────┐
│                        users                            │
├─────────────────────────────────────────────────────────┤
│ id: UUID (PK)                                          │
│ email: VARCHAR(255) UNIQUE                             │
│ name: VARCHAR(255)                                     │
│ autonomous_agents_enabled: BOOLEAN [NEW]               │
│ created_at: TIMESTAMP                                  │
│ updated_at: TIMESTAMP                                  │
└─────────────────────────────────────────────────────────┘
         │ 1
         │
         │ *
┌────────▼────────────────────────────────────────────────┐
│                        tasks                            │
├─────────────────────────────────────────────────────────┤
│ id: UUID (PK)                                          │
│ user_id: UUID (FK)                                     │
│ title: VARCHAR(200)                                    │
│ description: TEXT                                      │
│ completed: BOOLEAN                                     │
│ priority: VARCHAR(20)                                  │
│ tags: TEXT[]                                           │
│ category: VARCHAR(100)                                 │
│ due_date: TIMESTAMP                                    │
│ recurrence_pattern: VARCHAR(50)                        │
│ reminder_enabled: BOOLEAN                              │
│ reminder_offset_minutes: INT                           │
│ created_at: TIMESTAMP                                  │
│ updated_at: TIMESTAMP                                  │
└─────────────────────────────────────────────────────────┘
         │ 0..1
         │
         │ *
┌────────▼────────────────────────────────────────────────┐
│                  agent_suggestions [NEW]                │
├─────────────────────────────────────────────────────────┤
│ id: UUID (PK)                                          │
│ user_id: UUID (FK)                                     │
│ task_id: UUID (FK, nullable)                           │
│ suggestion_type: VARCHAR(50)                           │
│ message: TEXT                                          │
│ metadata: JSONB                                        │
│ dismissed: BOOLEAN                                     │
│ created_at: TIMESTAMP                                  │
│ expires_at: TIMESTAMP (nullable)                       │
└─────────────────────────────────────────────────────────┘
```

## Migration Strategy

### Migration File

```sql
-- Migration: Add agent suggestions table and user preference
-- Version: 20260124000000_add_agent_suggestions

-- Add autonomous_agents_enabled to users
ALTER TABLE users
ADD COLUMN IF NOT EXISTS autonomous_agents_enabled BOOLEAN DEFAULT TRUE;

-- Create agent_suggestions table
CREATE TABLE IF NOT EXISTS agent_suggestions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
  suggestion_type VARCHAR(50) NOT NULL,
  message TEXT NOT NULL,
  metadata JSONB DEFAULT '{}',
  dismissed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_agent_suggestions_user_id ON agent_suggestions(user_id);
CREATE INDEX IF NOT EXISTS idx_agent_suggestions_dismissed ON agent_suggestions(dismissed);
CREATE INDEX IF NOT EXISTS idx_agent_suggestions_type ON agent_suggestions(suggestion_type);
CREATE INDEX IF NOT EXISTS idx_agent_suggestions_created_at ON agent_suggestions(created_at);
```

### Rollback

```sql
-- Rollback: Remove agent suggestions
DROP TABLE IF EXISTS agent_suggestions;
ALTER TABLE users DROP COLUMN IF EXISTS autonomous_agents_enabled;
```

## Query Patterns

### Get Active Suggestions for User

```sql
SELECT * FROM agent_suggestions
WHERE user_id = $1
  AND dismissed = FALSE
  AND (expires_at IS NULL OR expires_at > NOW())
ORDER BY created_at DESC
LIMIT 20;
```

### Dismiss Suggestion

```sql
UPDATE agent_suggestions
SET dismissed = TRUE
WHERE id = $1 AND user_id = $2;
```

### Count Suggestions in Last Hour (Rate Limiting)

```sql
SELECT COUNT(*) FROM agent_suggestions
WHERE user_id = $1
  AND created_at > NOW() - INTERVAL '1 hour';
```

### Get Overdue Tasks for Agent

```sql
SELECT t.* FROM tasks t
JOIN users u ON t.user_id = u.id
WHERE t.due_date < NOW()
  AND t.completed = FALSE
  AND u.autonomous_agents_enabled = TRUE
  AND NOT EXISTS (
    SELECT 1 FROM agent_suggestions s
    WHERE s.task_id = t.id
      AND s.suggestion_type = 'overdue_reminder'
      AND s.created_at > NOW() - INTERVAL '24 hours'
  );
```

## Data Retention

| Entity | Retention Policy |
|--------|-----------------|
| agent_suggestions (dismissed) | 30 days after dismissal |
| agent_suggestions (expired) | Delete when expires_at passed |
| agent_suggestions (active) | No automatic deletion |

Retention can be implemented via scheduled cleanup job:

```sql
DELETE FROM agent_suggestions
WHERE (dismissed = TRUE AND created_at < NOW() - INTERVAL '30 days')
   OR (expires_at IS NOT NULL AND expires_at < NOW());
```
