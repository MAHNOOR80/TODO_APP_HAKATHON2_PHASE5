generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Priority {
  low
  medium
  high
}

model User {
  id                      String   @id @default(uuid()) @db.Uuid
  email                   String   @unique @db.VarChar(255)
  name                    String?  @db.VarChar(255)
  password                String
  full_name               String?  @map("full_name") @db.VarChar(255)
  autonomousAgentsEnabled Boolean  @default(true) @map("autonomous_agents_enabled")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  tasks            Task[]
  conversations    Conversation[]
  agentSuggestions AgentSuggestion[]

  @@map("users")
}

model Task {
  id                    String    @id @default(uuid()) @db.Uuid
  userId                String    @map("user_id") @db.Uuid
  title                 String    @db.VarChar(200)
  description           String?   @db.Text
  completed             Boolean   @default(false)
  priority              Priority  @default(medium)
  tags                  String[]  @default([])
  category              String?   @db.VarChar(100)
  dueDate               DateTime? @map("due_date") @db.Timestamptz
  recurrencePattern     String?   @map("recurrence_pattern") @db.VarChar(50)
  reminderEnabled       Boolean   @default(false) @map("reminder_enabled")
  reminderOffsetMinutes Int?      @map("reminder_offset_minutes")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  agentSuggestions AgentSuggestion[]

  @@index([userId], map: "idx_tasks_user_id")
  @@index([dueDate], map: "idx_tasks_due_date")
  @@index([completed], map: "idx_tasks_completed")
  @@index([userId, priority], map: "idx_tasks_user_priority")
  @@map("tasks")
}

model Conversation {
  id        String        @id @default(uuid()) @db.Uuid
  userId    String        @map("user_id") @db.Uuid
  title     String        @default("New Chat") @db.VarChar(255)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([userId])
  @@map("conversations")
}

model ChatMessage {
  id             String       @id @default(uuid()) @db.Uuid
  conversationId String       @map("conversation_id") @db.Uuid
  role           String       @db.VarChar(50)
  content        String       @db.Text
  createdAt      DateTime     @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("chat_messages")
}

// Suggestion types for autonomous agent recommendations
enum SuggestionType {
  overdue_reminder
  prioritization
  schedule_adjustment
  neglected_task
  general_insight
}

// Agent suggestions - autonomous recommendations for users
model AgentSuggestion {
  id             String         @id @default(uuid()) @db.Uuid
  userId         String         @map("user_id") @db.Uuid
  taskId         String?        @map("task_id") @db.Uuid
  suggestionType SuggestionType @map("suggestion_type")
  message        String         @db.Text
  metadata       Json           @default("{}")
  dismissed      Boolean        @default(false)
  createdAt      DateTime       @default(now()) @map("created_at")
  expiresAt      DateTime?      @map("expires_at") @db.Timestamptz
  sourceEvent    String?        @map("source_event") @db.VarChar(100)
  correlationId  String?        @map("correlation_id") @db.Uuid

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task? @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_agent_suggestions_user_id")
  @@index([dismissed], map: "idx_agent_suggestions_dismissed")
  @@index([suggestionType], map: "idx_agent_suggestions_type")
  @@index([createdAt], map: "idx_agent_suggestions_created_at")
  @@map("agent_suggestions")
}
